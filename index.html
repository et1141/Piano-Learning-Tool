<!DOCTYPE html>
<html lang="en">

<head>
    <title>Piano Learning Tool</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato|Raleway:700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Layout is based on: https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_band&stacked=h -->
    <style>
        body {
            font-family: "Lato", sans-serif
        }
        
        .section {
            display: none;
            padding: 64px 16px;
        }
        .active-section {
            display: block;
        }
    
        #upload-status {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-top: 40px;
        }
            
        .w3-bar .w3-title {
            font-family: 'Raleway', sans-serif;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
            line-height: 46px;
            padding: 0 16px;
        }
        
        .w3-bar .w3-button {
            height: 46px;
            line-height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-success-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        #songs-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .song-card {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }
        
        .song-card {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .song-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .song-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .song-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .song-info h3 {
            font-size: 1.1em;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .song-description {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 8px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .song-info p {
            font-size: 0.85em;
            margin: 4px 0;
            color: #333;
        }
        
        .song-info a {
            color: #0066cc;
            text-decoration: none;
            font-size: 0.85em;
        }
        
        .song-info a:hover {
            text-decoration: underline;
        }
        
        .song-buttons {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
        }
        
        .song-buttons button {
            flex: 1;
            margin: 4px 2px;
            padding: 6px 10px;
            border: none;
            background-color: #222;
            color: white;
            font-size: 0.85em;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .song-buttons button:hover {
            background-color: #444;
        }
        
        .song-buttons {
            display: flex;
            flex-wrap: wrap;
        }
        
        .song-buttons button {
            flex: 1 1 45%;
            /* 2 przyciski na rzÄ…d */
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <div class="w3-top">
        <div class="w3-bar w3-black w3-card" style="height:46px">
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('upload')">Upload</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('video')">Training Video</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('detect')">Pitch Detector</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('tutorial')">Tutorial</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('game')">Game</a>
            <span class="w3-bar-item w3-title w3-right">Piano Learning Tool</span>
            <!-- Songs dropdown -->
            <div class="w3-dropdown-hover w3-hide-small">
                <button class="w3-padding-large w3-button" title="Songs" onmouseover="load_song_list()" onclick="show_section('songs')">
                    Songs <i class="fa fa-caret-down  w3-padding-small"></i>
                </button>
                <div class="w3-dropdown-content w3-bar-block w3-card-4" id="songs-dropdown" style="margin-left:5px;"></div>
            </div>
        </div>
    </div>
    
    <!-- User Message Panel-->
    <div id="user-message" class="w3-panel" style="margin-top: 42px; text-align: center;  display: none;"></div>


    <!-- Sections -->
    <div class="w3-content" style="margin-top:46px">
        
        <!-- Upload Section -->
        <div id="upload" class="section active-section">
            <div class="w3-container">
                <!-- select model -->
                <label for="model-select">Select Model:</label>
                <select id="model-select">
                  <option value="transkun">Transkun</option>
                  <option value="basic_pitch">Basic Pitch</option>
                </select>
                <!-- upload from a file -->
                <h2>Upload a File</h2>
                <form id="upload-form">
                    <input type="file" id="audio-file" accept="audio/*" required class="w3-input w3-border w3-margin-bottom">
                    <button type="button" id="button-upload-file" class="w3-button w3-black" onclick="add_song()" style="margin-bottom: 20px;">Add song from file</button>
                </form>
                <!-- upload from a youtube link  -->
                <h2 for="youtube-url">Or Paste a YouTube URL:</h2>
                <input type="text" id="youtube-url" class="w3-input w3-border w3-margin-bottom" placeholder="https://www.youtube.com/watch?v=...">
                <button type="button" class="w3-button w3-black" onclick="add_song_youtube()">Add song fom YouTube</button>
                <!--upload status message box-->
                <p id="upload-status" class="w3-large w3-text-grey" style="display: none;">
                    .
                </p>

                <!--      <div id="midi-download" style="display:none;">
          <a id="midi-link" href="#" download="converted.mid" class="w3-button w3-black">Download MIDI File</a>
        </div>-->
            </div>
        </div>

        <!-- Video Section -->
        <div id="video" class="section">
            <div class="w3-container w3-center">
                <h2 class="w3-xxlarge w3-text-black w3-margin-top">Training Video</h2>
                <div id="video-container" style="margin-top: 30px; display: none;">
                    <video id="synthviz-video" controls style="width: 90%; max-width: 1080px; border: 2px solid #000; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">
                    <source id="video-source" src="" type="video/mp4">
                    Your browser does not support the video tag.
                    </video>
                </div>
                <p id="video-status" class="w3-large w3-text-grey" style="display: none; margin-bottom: 20px;">
                    Select a song to generate a video.
                </p>

            </div>
        </div>

        <!-- Detect Section -->
        <div id="detect" class="section">
            <div class="w3-container">
                <h2>Single Note Detector</h2>
                <p>Use your microphone to detect notes in real time using FFT.</p>

                <button id="listen-button" onclick="toggle_listening()"> Start Listening</button>
                <div id="note-display" style="font-size: 24px; margin-top: 20px;">Nuta: --</div>
            </div>
        </div>

        <!-- Tutorial Section -->
        <div id="tutorial" class="section">
            <div class="w3-container">
                <h2>Tutorial & Documentation</h2>
                <p>Instructions, video guides, and documentation will be available here.</p>
            </div>
        </div>

        <!-- Game Section -->

        <div id="game" class="section">
            <div id="game-root" class="w3-container">
                <iframe src="http://127.0.0.1:8000/game" width="100%" height="800px" style="border:none;"></iframe>
            </div>
        </div>

        <!-- Songs Section -->
        <div id="songs" class="section">
            <div class="w3-container">
                <div class="listing-section" id="songs-gallery">
                    <!-- Songs gallery will be generated here. -->
                </div>
            </div>
        </div>

    </div>

    <div id="manage-modal" class="w3-modal" style="z-index: 1000;">
        <div class="w3-modal-content w3-card-4" style="max-width: 600px;">
            <header class="w3-container w3-black">
                <span onclick="close_edit_modal()" class="w3-button w3-display-topright">&times;</span>
                <h3>Edit Song Version</h3>
            </header>
            <div class="w3-container w3-padding">
                <form id="manage-form">
                    <input type="hidden" id="manage-version-id">
                    <p><label>Title</label><input class="w3-input w3-border" id="manage-title" type="text"></p>
                    <p><label>Key Root</label>
                        <select class="w3-select w3-border" id="manage-key-root">
                          <option value="">-- Select Note --</option>
                          <option value="C">C</option>
                          <option value="C#">C#</option>
                          <option value="D">D</option>
                          <option value="D#">D#</option>
                          <option value="E">E</option>
                          <option value="F">F</option>
                          <option value="F#">F#</option>
                          <option value="G">G</option>
                          <option value="G#">G#</option>
                          <option value="A">A</option>
                          <option value="A#">A#</option>
                          <option value="B">B</option>
                        </select>
                    </p>
                    <p><label>Key Mode</label><input class="w3-input w3-border" id="manage-key-mode" type="text"></p>
                    <p><label>Picture URL</label><input class="w3-input w3-border" id="manage-picture" type="text"></p>
                    <p><label>Description</label><textarea class="w3-input w3-border" id="manage-description"></textarea></p>
                    <p><label>Is Public</label>
                        <select class="w3-select w3-border" id="manage-is-public">
                  <option value="1">Yes</option>
                  <option value="0">No</option>
                </select>
                    </p>
                    <div class="w3-center w3-padding">
                        <button type="button" class="w3-button w3-black" style="width: 32%;" onclick="save_song(false)">Save Changes</button>
                        <button type="button" class="w3-button w3-black" style="width: 32%;" onclick="save_song(true)">Save as New Version</button>
                        <button type="button" class="w3-button w3-black" style="width: 32%;" onclick="delete_song()">Delete</button>
                    
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        let currentSong = null; // song_id
        let currentSection = null


        function get_status_spinner_message_html(message){
            return `
                     <span id="status-text">
                        ${message}
                     </span>
                     <i class="fa fa-spinner fa-spin" aria-hidden="true" style="margin-left: 8px;"></i>
                   `;
        }

        async function show_section(id,restart = false) {
            const sections = document.getElementsByClassName('section');

            if (id === currentSection && !restart){
                return;
            }


            for (const section of sections) {
                section.classList.remove('active-section');
            }
            document.getElementById(id).classList.add('active-section');
            

            //pause video when leaving video section
            if (currentSection === 'video' && id !== 'video') {
                const video = document.getElementById('synthviz-video');
                if (video && !video.paused) {
                    video.pause();
                }
            }   
            
            //section sepecific functionalities 
            if (id === 'songs') {
                load_songs_gallery();
            }
            else if (id === 'video') {
                generate_training_video()
            }

            currentSection = id
        }



        async function load_song_list() {
            const dropdown = document.getElementById('songs-dropdown');

            try {
                const res = await fetch('http://localhost:8000/api/get-songs-list-dropdown');
                const songs = await res.json();


                dropdown.innerHTML = '';

                if (songs.length === 0) {
                    dropdown.innerHTML = '<span class="w3-bar-item">No songs available</span>';
                    return;
                }

                songs.forEach(song => {

                    const version_id = song.version_id
                    const title = song.title
                    //console.log(song)
                    //console.log('ASFAFSFAS')

                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'w3-bar-item w3-button';

                    //cut long name
                    // const maxLength = 30;
                    // const displayName = song.length > maxLength ? song.slice(0, maxLength - 6) + '....mid' : song;
                    item.innerText = title;

                    // hihlight active
                    if (String(version_id) === String(currentSong)) {
                        item.classList.add('w3-black');
                        item.style.pointerEvents = 'none';
                    }

                    item.onclick = () => {
                        //  if (currentSong != song) {
                        //      elementsToShowOnSongChange.forEach(id => {
                        //          const el = document.getElementById(id);
                        //          if (el) el.style.display = 'block-inline';
                        //      });
                        //  }
                        select_song(version_id);

                        console.log('Selected MIDI file:', currentSong);
                    };

                    dropdown.appendChild(item);
                });

            } catch (err) {
                console.error('Failed to load songs:', err);
            }
        }


        async function load_songs_gallery() {
            const container = document.getElementById('songs-gallery');
            container.innerHTML = '<p>Loading songs...</p>';

            try {
                const res = await fetch('http://localhost:8000/api/get-songs-list-gallery');
                const songs = await res.json();
                container.innerHTML = ''; // Clear loading message

                if (songs.length === 0) {
                    container.innerHTML = '<p>No songs available.</p>';
                    return;
                }

                songs.forEach(song => {
                    const songContainer = document.createElement('div');
                    songContainer.className = 'song-cart';

                    const imgUrl = song.picture_path || 'static/music2.png';
                    const descriptionHTML = song.description ? `<p class="song-description">${song.description}</p>` : '';
                    const keyHTML = (song.key_root || song.key_mode) ? `<p><strong>Key:</strong> ${song.key_root || '--'} ${song.key_mode || ''}</p>` : '';
                    const sourceHTML = song.source ? `<p><a href="${song.source}" target="_blank">Source</a></p>` : '';
                    let selectBtnHTML = ''
                    if (String(song.version_id) === String(currentSong)) {
                        selectBtnHTML = `<button class="w3-grey" onclick="select_song('${song.version_id}')">Select</button>`;
                    } else {
                        selectBtnHTML = `<button onclick="select_song('${song.version_id}')">Select</button>`;
                    }

                    songContainer.innerHTML = `
                            <div class="song-card">
                                <img src="${imgUrl}" alt="${song.title}">
                                <div class="song-info">
                                <h3>${song.title}</h3>
                                ${descriptionHTML}
                                <p><strong>Duration:</strong> ${song.duration || '--'}</p>
                                    ${keyHTML}
                                ${sourceHTML}
                                    <div class="song-buttons">
                                        ${selectBtnHTML}
                                        <button onclick="manage_song('${song.version_id}')">Manage</button>
                                        <button onclick="download_song_xml('${song.version_id}')">MusicXML</button>
                                        <button onclick="download_song_pdf('${song.version_id}')">Sheet Music</button>

                                </div>
                                </div>
                            </div>
                            `;
                    container.appendChild(songContainer);
                });

            } catch (err) {
                console.error('Error loading songs:', err);
                container.innerHTML = '<p>Failed to load songs. Check the console for more info.</p>';
            }
        }


        function select_song(versionId) {
            console.log("HELLO FROM SELECT_SONG")
            currentSong = versionId;
            load_song_list(); // to refresh dropdown with new highlight
            load_songs_gallery(); //TODO: Jesli nie chce ponownego ladowania strony to usun, ale wtedy nie bedzie tez podswietlania przycisku
            if (currentSection === 'video') { //reload video by loading video section again
                show_section('video',true) 
            }
        }


        function manage_song(versionId) { //displays "manage_song modal"
            fetch(`http://localhost:8000/api/get-song-version/${versionId}`)
                .then(res => res.json())
                .then(song => {
                    document.getElementById('manage-version-id').value = song.version_id;
                    document.getElementById('manage-title').value = song.title || '';
                    document.getElementById('manage-key-root').value = song.key_root || '';
                    document.getElementById('manage-key-mode').value = song.key_mode || '';
                    document.getElementById('manage-picture').value = song.picture_path || '';
                    document.getElementById('manage-description').value = song.description || '';
                    document.getElementById('manage-is-public').value = song.is_public ? '1' : '0';
                    document.getElementById('manage-modal').style.display = 'block';
                })
                .catch(err => {
                    console.error("Error fetching song version:", err);
                    alert("Could not load song details.");
                });
        }


        async function save_song(asNewVersion = false) {
            
        
            const data = {
                version_id: document.getElementById('manage-version-id').value,
                title_version: document.getElementById('manage-title').value,
                key_root: document.getElementById('manage-key-root').value,
                key_mode: document.getElementById('manage-key-mode').value,
                picture_path: document.getElementById('manage-picture').value,
                description: document.getElementById('manage-description').value,
                is_public: parseInt(document.getElementById('manage-is-public').value),
                save_as_new: asNewVersion // MoÅ¼esz to obsÅ‚uÅ¼yÄ‡ w backendzie
            };

            try {
                const res = await fetch(`http://localhost:8000/api/update-song`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error("Update failed");

                close_edit_modal();
                load_songs_gallery();
                show_user_message("Song version updated successfully.");

                if (parseInt(data.version_id) === currentSong) {
                    console.log("hello from save_song")
                    generate_training_video(true); //reload video section if the edited song is curr song //TODO add condition: key_root was changed
                }


            } catch (err) {
                console.error("Update error:", err);
                show_user_message("Failed to update song version.", true);
            }
        }


        function delete_song(asNewVersion = false) {
            const versionId = document.getElementById('manage-version-id').value;

            fetch(`http://localhost:8000/api/delete-song-version/${versionId}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.error || 'Unknown error') });
                }
                return res.json();
            })
            .then(() => {
                close_edit_modal();
                load_songs_gallery();
                show_user_message("Song version deleted successfully.");
            })
            .catch(err => {
                console.error("Error deleting song version:", err);
                show_user_message("Could not delete song version", true);
            });
        }



        function close_edit_modal() {
            document.getElementById('manage-modal').style.display = 'none';
        }



        function download_song_xml(versionId) {
            const xmlUrl = `http://localhost:8000/api/get-musicxml?song_version_id=${versionId}`;
            const link = document.createElement('a');
            link.href = xmlUrl;
            link.download = '';
            link.click();
        }

        function download_song_pdf(versionId) {
            const pdfUrl = `http://localhost:8000/api/get-pdf?song_version_id=${versionId}`;
            const link = document.createElement('a');
            link.href = pdfUrl;
            link.download = '';
            link.click();
        }


        function show_user_message(message, isError = false) {
            const msgBox = document.getElementById('user-message');
            msgBox.className = isError ? 'w3-panel w3-red' : 'w3-panel w3-green';
            msgBox.textContent = message;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000); //dissapear after 5 sec
        }



        async function unlock_new_song_lock() {
            try {
                const res = await fetch('http://localhost:8000/api/unlock-upload', {
                    method: 'POST'
                });
                const data = await res.json();
                console.log('[unlock_new_song_lock] Server response:', data.status);
            } catch (err) {
                console.error('[unlock_new_song_lock] Failed to unlock upload:', err);
            }
        }


        async function convert_file(song_id) {
            const modelSelect = document.getElementById('model-select');
            const dataApi = {
                song_id: song_id,
                model_name: modelSelect.value
            };

            try {
                const res = await fetch('http://localhost:8000/api/convert-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataApi)
                });
                if (!res.ok) {
                    const text = await res.text();  
                    throw new Error(`HTTP ${res.status} â€“ ${text}`);
                }

                const data = await res.json();
                if (data.title) {
                    load_song_list();
                    load_songs_gallery();
                    show_user_message(`The song "${data.title}" was converted successfully.`);
                    //TODO: czy moze po dodaniu ustawic currentSong=data.song_version_id ? 
                } else {
                    show_user_message('Error converting file. No MIDI generated.', true);
                    // TODO: czy tu usunac piosenke z bazy danych? (skoro nie da sie jej skonwertowac?)
                }
            } catch (error) {
                console.error('Conversion failed:', error);
                await unlock_new_song_lock();  
                show_user_message(`Conversion failed: ${error.message}`, true);
            }
        }


        async function add_song() {
            const fileInput = document.getElementById('audio-file');
            const statusText = document.getElementById('upload-status');
            let cleanStatusText = true

            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an audio file first.');
                return;
            }

            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                const res = await fetch('http://localhost:8000/api/upload-audio', {
                    method: 'POST',
                    body: formData
                });
                
                if (!res.ok) {
                    if (res.status === 429) {
                        console.log("Another upload is already in progress (429). Upload canceled.");
                        show_user_message("Another song is currently being uploaded. Please wait and try again when it's done.", true);
                        cleanStatusText=false
                        return; // Another upload job is in progress â€” stop this one
                    }
                    const text = await res.text(); 
                    throw new Error(`HTTP ${res.status} â€“ ${text}`);
                }

                statusText.style.display = 'flex';
                statusText.innerHTML = get_status_spinner_message_html(`Uploading file: ${file.name} ... please wait`)

                const data = await res.json();
                if (data.song_id) {
                    statusText.innerHTML = get_status_spinner_message_html(`Transcribing the file: ${file.name} ... please wait`)
                    await convert_file(data.song_id);
                } else {
                    show_user_message('Upload failed: Could not get song ID during transcription. Try to upload again.', true);
                }
            } catch (err) {
                console.error('Upload failed:', err);
                show_user_message(`Upload failed: ${err.message}`, true);
                await unlock_new_song_lock();  
            } finally {
                if (cleanStatusText){
                 statusText.innerHTML = ``;
                 statusText.style.display='none';
                }
            }
        }


        async function add_song_youtube() {
            const url = document.getElementById('youtube-url').value;
            const statusText = document.getElementById('upload-status');
            let cleanStatusText = true

            if (!url) {
                alert('Please enter a YouTube link.');
                return;
            }

            try {
                const res = await fetch('http://localhost:8000/api/download-upload-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        youtube_url: url
                    })
                });

                if (!res.ok) {
                    if (res.status === 429) {
                        cleanStatusText = false
                        console.log("Another upload is already in progress (429). Upload canceled.");
                        show_user_message("Another song is currently being uploaded. Please wait and try again.", true);
                        return; // Another upload job is in progress â€” stop this one
                    }
                    const text = await res.text();  
                    throw new Error(`HTTP ${res.status} â€“ ${text}`);
                }

                statusText.style.display = 'flex';
                statusText.innerHTML = get_status_spinner_message_html(`Downloading song from: ${url} ... please wait`);

                const data = await res.json();
                if (data.song_id) {
                    statusText.innerHTML = get_status_spinner_message_html(`Transcribing the song: ${data.title} ... please wait`);
                    await convert_file(data.song_id);
                } else {
                    show_user_message('Upload failed: Could not get song ID. Try to upload again.', true);
                }
            } catch (err) {
                console.error('Upload failed:', err);
                show_user_message(`Upload failed: ${err.message}`, true);
                await unlock_new_song_lock();  

            }
            finally {
                if (cleanStatusText){
                 statusText.innerHTML = ``;
                 statusText.style.display='none';
                }
            }
        }



        

        async function wait_for_video(url, retries = 15, delay = 4000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, { method: 'HEAD' });
                    if (res.ok || res.status === 429){ 
                        return res;
                    }
                    if (res.status === 500) {
                        console.warn(`[wait_for_video] Server error 500 at attempt ${i + 1}`);
                    }
                } catch (e) {
                    console.warn("HEAD request failed", e);
                }
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            return null;
        }

        async function generate_training_video(forceReload = false) {
            if (!currentSong) {
                alert("No song selected.");
                return;
            }
            console.log("[generate_training_video]")
            currVersionId= currentSong

            const statusText = document.getElementById('video-status');
            const container = document.getElementById('video-container');
            const video = document.getElementById('synthviz-video');
            const source = document.getElementById('video-source');

            video.pause();
            video.currentTime = 0;
            source.src = '';
            statusText.style.display = 'block';
            container.style.display = 'none';
            statusText.innerHTML = get_status_spinner_message_html(`Generating video... please wait`);

            try {
                let videoUrl = `http://localhost:8000/api/get-video?song_version_id=${currentSong}`; 
                
                //refresh by adding timestamp
                if (forceReload) {
                    videoUrl += `&t=${Date.now()}`; // forc
                }

                const res = await wait_for_video(videoUrl);
                if (!res) {
                    statusText.innerHTML = `<span style="color: red;">Video generation timed out.</span>`;
                    return;
                }

                 if (res.status === 429) {
                    console.log("Video is already generating (429). Waiting...");
                    return; // There is another job generating video for the song. The other job will load the video. So we can simply end this job here.
                }
                 source.src = videoUrl;
                video.load();
                
                if (res.status === 201) { // A new video was generated by the backend (likely a time-consuming operation) â€” inform the user
                    const songUrl = `http://localhost:8000/api/get-song-version/${currVersionId}`;
                    const resSongVersion = await fetch(songUrl);
                    const data = await resSongVersion.json();
                    if (!resSongVersion.ok || !data.success) {
                        throw new Error(data.error || 'Failed to get song title');
                    }
                    const title = data.title?.title || 'Unknown Title';
                    show_user_message(`Video for the song "${title}" was generated`);
                }

                statusText.style.display = 'none';
                container.style.display = 'block';

            } catch (error) {
                console.error("Error generating video:", error);
                statusText.style.display = 'block';
                statusText.innerHTML = `<span style="color: red;"> Error loading video.</span>`;
                container.style.display = 'none';
            }
        }


  



        // ****************************************************** Note detect part ******************************************************
        let audioContext, analyser, microphone, dataArray, animationId;
        let isListening = false;

        async function toggle_listening() {
            const button = document.getElementById('listen-button');

            if (isListening) {
                stop_listening();
                button.textContent = 'Start Listening';
            } else {
                await start_listening();
                button.textContent = 'Stop Listening';
            }
        }

        async function start_listening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                audioContext = new(window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Float32Array(bufferLength);

                isListening = true;
                listen_loop();
            } catch (err) {
                console.error('Microphone access error:', err);
            }
        }

        function stop_listening() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (audioContext) {
                audioContext.close();
            }
            document.getElementById('note-display').textContent = 'Nuta: --';
            isListening = false;
        }

        function listen_loop() {
            analyser.getFloatFrequencyData(dataArray);

            const note = detect_note_from_fft(dataArray, audioContext.sampleRate);
            document.getElementById('note-display').textContent = 'Nuta: ' + (note || '--');

            if (isListening) {
                animationId = requestAnimationFrame(listen_loop);
            }
        }

        function detect_note_from_fft(dataArray, sampleRate) {
            let maxVal = -Infinity;
            let maxIndex = -1;

            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            // PrÃ³g: jeÅ›li sygnaÅ‚ za sÅ‚aby, zwrÃ³Ä‡ null
            if (maxVal < -60) {
                return null;
            }

            const frequency = maxIndex * sampleRate / (2 * dataArray.length);
            return frequency_to_note_name(frequency);
        }

        function frequency_to_note_name(freq) {
            if (freq < 20 || freq > 5000) return null;

            const noteStrings = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const A4 = 440;
            const semitones = 12 * Math.log2(freq / A4);
            const noteIndex = Math.round(semitones) + 57; // A4 = index 57
            const noteName = noteStrings[noteIndex % 12];
            const octave = Math.floor(noteIndex / 12);
            return `${noteName}${octave}`;
        }

        // ************************************************************************************************************************
    </script>

</body>

</html>