<!DOCTYPE html>
<html lang="en">

<head>
    <title>Piano Learning Tool</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato|Raleway:700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> D
    <!-- Layout is based on: https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_band&stacked=h -->
    <style>
        body {
            font-family: "Lato", sans-serif
        }
        
        .section {
            display: none;
            padding: 64px 16px;
        }
        
        .active-section {
            display: block;
        }
        
        .w3-bar .w3-title {
            font-family: 'Raleway', sans-serif;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 1px;
            line-height: 46px;
            padding: 0 16px;
        }
        
        .w3-bar .w3-button {
            height: 46px;
            line-height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-success-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        #songs-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .song-card {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }
        
        .song-card {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 8px;
        }
        
        .song-card:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .song-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .song-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .song-info h3 {
            font-size: 1.1em;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .song-description {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 8px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .song-info p {
            font-size: 0.85em;
            margin: 4px 0;
            color: #333;
        }
        
        .song-info a {
            color: #0066cc;
            text-decoration: none;
            font-size: 0.85em;
        }
        
        .song-info a:hover {
            text-decoration: underline;
        }
        
        .song-buttons {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
        }
        
        .song-buttons button {
            flex: 1;
            margin: 4px 2px;
            padding: 6px 10px;
            border: none;
            background-color: #222;
            color: white;
            font-size: 0.85em;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .song-buttons button:hover {
            background-color: #444;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <div class="w3-top">
        <div class="w3-bar w3-black w3-card" style="height:46px">
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('upload')">Upload</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('visualize')">Visualize</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('video')">Training Video</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('detect')">Note Detector</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('tutorial')">Tutorial</a>
            <a href="#" class="w3-bar-item w3-button w3-padding-large" onclick="show_section('game')">Game</a>

            <span class="w3-bar-item w3-title w3-right">Piano Learning Tool</span>

            <div class="w3-dropdown-hover w3-hide-small">
                <button class="w3-padding-large w3-button" title="Songs" onmouseover="load_song_list()" onclick="show_section('songs')">
                    Songs <i class="fa fa-caret-down  w3-padding-small"></i>
                </button>
                <div class="w3-dropdown-content w3-bar-block w3-card-4" id="songs-dropdown" style="margin-left:5px;"></div>
            </div>



        </div>
    </div>

    <!-- Sections -->
    <div class="w3-content" style="margin-top:46px">

        <div id="upload" class="section active-section">
            <div class="w3-container">

                <!-- select model -->
                <label for="model-select">Select Model:</label>
                <select id="model-select">
        <option value="transkun">Transkun</option>
        <option value="basic_pitch">Basic Pitch</option>
      </select>

                <!-- upload from a file -->
                <h2>Upload a File</h2>
                <form id="upload-form">
                    <input type="file" id="audio-file" accept="audio/*" required class="w3-input w3-border w3-margin-bottom">
                    <button type="button" id="button-upload-file" class="w3-button w3-black" onclick="upload_file()" style="margin-bottom: 20px;">Upload a File</button>
                </form>
                <!-- upload from a youtube link  -->
                <h2 for="youtube-url">Or Paste a YouTube URL:</h2>
                <input type="text" id="youtube-url" class="w3-input w3-border w3-margin-bottom" placeholder="https://www.youtube.com/watch?v=...">
                <button type="button" class="w3-button w3-black" onclick="upload_file_youtube()">Upload from YouTube</button>

                <!--      <div id="midi-download" style="display:none;">
          <a id="midi-link" href="#" download="converted.mid" class="w3-button w3-black">Download MIDI File</a>
        </div>-->
                <div id="upload-message" class="w3-panel w3-green" style="display: none; margin-top: 42px;"></div>

            </div>
        </div>

        <div id="visualize" class="section">
            <div class="w3-container">
                <h2>Visualize MIDI</h2>
                <p>Here you will be able to preview and edit note pitch, view piano animation, and export a PDF score.</p>
            </div>
        </div>

        <div id="video" class="section">
            <div class="w3-container w3-center">
                <h2 class="w3-xxlarge w3-text-black w3-margin-top">Training Video</h2>
                <div id="video-container" style="margin-top: 30px; display: none;">
                    <video id="synthviz-video" controls style="width: 90%; max-width: 1080px; border: 2px solid #000; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">
                    <source id="video-source" src="" type="video/mp4">
                    Your browser does not support the video tag.
                    </video>
                </div>

                <button id="generate-video-btn" class="w3-button w3-black w3-xlarge w3-margin-top w3-margin-bottom" onclick="generate_training_video()"> Generate Video </button>

                <p id="video-status" class="w3-large w3-text-grey" style="display: none; margin-bottom: 20px;">
                    Select song and click the button above to generate a video.
                </p>

            </div>
        </div>


        <div id="detect" class="section">
            <div class="w3-container">
                <h2>Single Note Detector</h2>
                <p>Use your microphone to detect notes in real time using FFT.</p>

                <button id="listen-button" onclick="toggle_listening()">ðŸŽ™ Start Listening</button>
                <div id="note-display" style="font-size: 24px; margin-top: 20px;">Nuta: --</div>
            </div>
        </div>


        <div id="tutorial" class="section">
            <div class="w3-container">
                <h2>Tutorial & Documentation</h2>
                <p>Instructions, video guides, and documentation will be available here.</p>
            </div>
        </div>

        <div id="game" class="section">
            <div id="game-root" class="w3-container">
                <iframe src="http://127.0.0.1:8000/game" width="100%" height="800px" style="border:none;"></iframe>
            </div>
        </div>

        <div id="songs" class="section">
            <div class="w3-container">
                <div class="listing-section" id="songs-gallery">
                    <!-- Songs will be generated here. The code for visualizing the list of songs is based on CodePen project: https://codepen.io/aaronbarnard/pen/oeWvJo-->
                </div>
            </div>
        </div>

    </div>

    <div id="edit-modal" class="w3-modal" style="z-index: 1000;">
        <div class="w3-modal-content w3-card-4" style="max-width: 600px;">
            <header class="w3-container w3-black">
                <span onclick="close_edit_modal()" class="w3-button w3-display-topright">&times;</span>
                <h3>Edit Song Version</h3>
            </header>
            <div class="w3-container w3-padding">
                <form id="edit-form">
                    <input type="hidden" id="edit-version-id">
                    <p><label>Title</label><input class="w3-input w3-border" id="edit-title" type="text"></p>
                    <p><label>Key Root</label><input class="w3-input w3-border" id="edit-key-root" type="text"></p>
                    <p><label>Key Mode</label><input class="w3-input w3-border" id="edit-key-mode" type="text"></p>
                    <p><label>Picture URL</label><input class="w3-input w3-border" id="edit-picture" type="text"></p>
                    <p><label>Description</label><textarea class="w3-input w3-border" id="edit-description"></textarea></p>
                    <p><label>Is Public</label>
                        <select class="w3-select w3-border" id="edit-is-public">
                  <option value="1">Yes</option>
                  <option value="0">No</option>
                </select>
                    </p>
                    <div class="w3-center w3-padding">
                        <button class="w3-button w3-black" type="submit">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        let currentSong = null; // song_id

        const elementsToShowOnSongChange = ['video-status', 'generate-video-btn']

        async function show_section(id) {
            const sections = document.getElementsByClassName('section');

            for (const section of sections) {
                section.classList.remove('active-section');
            }
            document.getElementById(id).classList.add('active-section');
            if (id === 'songs') {
                load_songs_gallery();
            }




        }



        async function load_song_list() {
            const dropdown = document.getElementById('songs-dropdown');

            try {
                const res = await fetch('http://localhost:8000/api/get-songs-list-dropdown');
                const songs = await res.json();


                dropdown.innerHTML = '';

                if (songs.length === 0) {
                    dropdown.innerHTML = '<span class="w3-bar-item">No songs available</span>';
                    return;
                }

                songs.forEach(song => {

                    const version_id = song.version_id
                    const title = song.title
                    console.log(song)
                    console.log('ASFAFSFAS')

                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'w3-bar-item w3-button';

                    //cut long name
                    // const maxLength = 30;
                    // const displayName = song.length > maxLength ? song.slice(0, maxLength - 6) + '....mid' : song;
                    item.innerText = title;

                    // hihlight active
                    if (String(version_id) === String(currentSong)) {
                        item.classList.add('w3-black');
                        item.style.pointerEvents = 'none';
                    }

                    item.onclick = () => {
                        if (currentSong != song) {
                            elementsToShowOnSongChange.forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.style.display = 'block-inline';
                            });
                        }
                        select_song(version_id);

                        console.log('Selected MIDI file:', currentSong);
                    };

                    dropdown.appendChild(item);
                });

            } catch (err) {
                console.error('Failed to load songs:', err);
            }
        }


        async function load_songs_gallery() {
            const container = document.getElementById('songs-gallery');
            container.innerHTML = '<p>Loading songs...</p>';

            try {
                const res = await fetch('http://localhost:8000/api/get-songs-list-gallery');
                const songs = await res.json();
                container.innerHTML = ''; // Clear loading message

                if (songs.length === 0) {
                    container.innerHTML = '<p>No songs available.</p>';
                    return;
                }

                songs.forEach(song => {
                    const songContainer = document.createElement('div');
                    songContainer.className = 'song-cart';

                    const imgUrl = song.picture_path || 'static/music2.png';
                    const descriptionHTML = song.description ? `<p class="song-description">${song.description}</p>` : '';
                    const keyHTML = (song.key_root || song.key_mode) ? `<p><strong>Key:</strong> ${song.key_root || '--'} ${song.key_mode || ''}</p>` : '';
                    const sourceHTML = song.source ? `<p><a href="${song.source}" target="_blank">Source</a></p>` : '';
                    let selectBtnHTML = ''
                    if (String(song.version_id) === String(currentSong)) {
                        selectBtnHTML = `<button class="w3-grey" onclick="select_song('${song.version_id}')">Select</button>`;
                    } else {
                        selectBtnHTML = `<button onclick="select_song('${song.version_id}')">Select</button>`;
                    }

                    songContainer.innerHTML = `
                            <div class="song-card">
                                <img src="${imgUrl}" alt="${song.title}">
                                <div class="song-info">
                                <h3>${song.title}</h3>
                                ${descriptionHTML}
                                <p><strong>Duration:</strong> ${song.duration || '--'}</p>
                                    ${keyHTML}
                                ${sourceHTML}
                                    <div class="song-buttons">
                                        ${selectBtnHTML}
                                        <button onclick="edit_song('${song.version_id}')">Edit</button>
                                </div>
                                </div>
                            </div>
                            `;
                    container.appendChild(songContainer);
                });

            } catch (err) {
                console.error('Error loading songs:', err);
                container.innerHTML = '<p>Failed to load songs. Check the console for more info.</p>';
            }
        }


        function select_song(versionId) {
            currentSong = versionId;
            load_song_list(); // to refresh dropdown with new highlight
            load_songs_gallery(); //TODO: Jesli nie chce ponownego ladowania strony to usun, ale wtedy nie bedzie tez podswietlania przycisku
        }


        function edit_song(versionId) {
            fetch(`http://localhost:8000/api/get-song-version/${versionId}`)
                .then(res => res.json())
                .then(song => {
                    document.getElementById('edit-version-id').value = song.version_id;
                    document.getElementById('edit-title').value = song.title || '';
                    document.getElementById('edit-key-root').value = song.key_root || '';
                    document.getElementById('edit-key-mode').value = song.key_mode || '';
                    document.getElementById('edit-picture').value = song.picture_path || '';
                    document.getElementById('edit-description').value = song.description || '';
                    document.getElementById('edit-is-public').value = song.is_public ? '1' : '0';
                    document.getElementById('edit-modal').style.display = 'block';
                })
                .catch(err => {
                    console.error("Error fetching song version:", err);
                    alert("Could not load song details.");
                });
        }

        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const payload = {
                version_id: document.getElementById('edit-version-id').value,
                title_version: document.getElementById('edit-title').value,
                key_root: document.getElementById('edit-key-root').value,
                key_mode: document.getElementById('edit-key-mode').value,
                picture_path: document.getElementById('edit-picture').value,
                description: document.getElementById('edit-description').value,
                is_public: parseInt(document.getElementById('edit-is-public').value)
            };

            try {
                const res = await fetch(`http://localhost:8000/api/update-song`, {
                    method: 'POST', // jak w Twoim endpointzie
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Update failed");

                close_edit_modal();
                load_songs_gallery();
                show_upload_message("Song version updated successfully.");
            } catch (err) {
                console.error("Update error:", err);
                show_upload_message("Failed to update song version.", true);
            }
        });


        function close_edit_modal() {
            document.getElementById('edit-modal').style.display = 'none';
        }



        function show_upload_message(message, isError = false) {
            const msgBox = document.getElementById('upload-message');
            msgBox.className = isError ? 'w3-panel w3-red' : 'w3-panel w3-green';
            msgBox.textContent = message;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 7000); //dissapear after 5 sec
        }


        async function convert_file(song_id) {
            const modelSelect = document.getElementById('model-select');
            const formData = new FormData();
            formData.append('song_id', song_id);
            formData.append('model_name', modelSelect.value);

            try {
                const response = await fetch('http://localhost:8000/api/convert-audio', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.title) {
                    currentSong = data.song_version_id;
                    load_song_list();
                    const title = data.title
                    show_upload_message(`The song "${title}" was converted successfully.`);
                    //TODO: czy moze po dodaniu ustawic currentSong=data.song_version_id ? 
                } else {
                    show_upload_message('Error converting file. No MIDI generated.', true);
                    // TODO: czy tu usunac piosenke z bazy danych? (skoro nie da sie jej skonwertowac?)
                }
            } catch (error) {
                console.error('Conversion failed:', error);
                show_upload_message(`Conversion failed: ${error.message}`, true);
            }
        }


        async function upload_file() {
            const fileInput = document.getElementById('audio-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an audio file first.');
                return;
            }
            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                const response = await fetch('http://localhost:8000/api/upload-audio', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.song_id) {
                    await convert_file(data.song_id);
                } else {
                    show_upload_message('Upload failed: Could not get song ID. Try to upload again.', true);
                }
            } catch (err) {
                console.error('Upload failed:', err);
                show_upload_message(`Upload failed: ${err.message}`, true);
            }
        }


        async function upload_file_youtube() {
            const url = document.getElementById('youtube-url').value;
            if (!url) {
                alert('Please enter a YouTube link.');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/api/download-upload-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        youtube_url: url
                    })
                });

                const data = await response.json();
                if (response.ok && data.song_id) {
                    await convert_file(data.song_id);
                } else {
                    show_upload_message('Upload failed: Could not get song ID. Try to upload again.', true);
                }
            } catch (err) {
                console.error('Upload failed:', err);
                show_upload_message(`Upload failed: ${err.message}`, true);
            }
        }


        async function generate_training_video() {
            if (!currentSong) {
                alert("No song selected.");
                return;
            }

            const btn = document.getElementById('generate-video-btn');
            const statusText = document.getElementById('video-status');
            const container = document.getElementById('video-container');
            const video = document.getElementById('synthviz-video');
            const source = document.getElementById('video-source');

            btn.disabled = true;
            statusText.style.display = 'block';
            statusText.innerText = 'Generating video, please wait...';
            btn.innerText = 'Generate Video';
            btn.style.display = 'none';
            container.style.display = 'none';



            try {
                const res = await fetch("http://localhost:8000/api/get-video", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        song_version_id: currentSong
                    })
                });

                if (!res.ok) {
                    throw new Error(`Failed to generate video: ${res.status}`);
                }

                const data = await res.json();
                const videoUrl = data.video_url;

                source.src = videoUrl;
                video.load();
                container.style.display = 'block';
                statusText.style.display = 'none';
                statusText.style.display = 'none';

                btn.innerText = 'Generate New Video';
                statusText.innerText = 'Select a new song and click the button above to generate a new video.';
                show_section('video');

            } catch (error) {
                console.error("Error generating video:", error);
                statusText.innerText = 'Error generating video.';
            } finally {
                btn.disabled = false;
            }
        }




        // ****************************************************** Note detect part ******************************************************
        let audioContext, analyser, microphone, dataArray, animationId;
        let isListening = false;

        async function toggle_listening() {
            const button = document.getElementById('listen-button');

            if (isListening) {
                stop_listening();
                button.textContent = 'ðŸŽ™ Start Listening';
            } else {
                await start_listening();
                button.textContent = 'ðŸ›‘ Stop Listening';
            }
        }

        async function start_listening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                audioContext = new(window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Float32Array(bufferLength);

                isListening = true;
                listen_loop();
            } catch (err) {
                console.error('Microphone access error:', err);
            }
        }

        function stop_listening() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (audioContext) {
                audioContext.close();
            }
            document.getElementById('note-display').textContent = 'Nuta: --';
            isListening = false;
        }

        function listen_loop() {
            analyser.getFloatFrequencyData(dataArray);

            const note = detect_note_from_fft(dataArray, audioContext.sampleRate);
            document.getElementById('note-display').textContent = 'Nuta: ' + (note || '--');

            if (isListening) {
                animationId = requestAnimationFrame(listen_loop);
            }
        }

        function detect_note_from_fft(dataArray, sampleRate) {
            let maxVal = -Infinity;
            let maxIndex = -1;

            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            // PrÃ³g: jeÅ›li sygnaÅ‚ za sÅ‚aby, zwrÃ³Ä‡ null
            if (maxVal < -60) {
                return null;
            }

            const frequency = maxIndex * sampleRate / (2 * dataArray.length);
            return frequency_to_note_name(frequency);
        }

        function frequency_to_note_name(freq) {
            if (freq < 20 || freq > 5000) return null;

            const noteStrings = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const A4 = 440;
            const semitones = 12 * Math.log2(freq / A4);
            const noteIndex = Math.round(semitones) + 57; // A4 = index 57
            const noteName = noteStrings[noteIndex % 12];
            const octave = Math.floor(noteIndex / 12);
            return `${noteName}${octave}`;
        }

        // ************************************************************************************************************************
    </script>

</body>

</html>